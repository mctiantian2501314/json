name: Fast JSON Sync

on:
  push:
    paths:
      - '*.json'
    branches: [ main ]

jobs:
  sync-json:
    runs-on: ubuntu-latest
    timeout-minutes: 3  # 设置超时限制
    permissions:
      contents: write

    steps:
    - name: Checkout (Shallow)
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # 浅层克隆加速检出

    - name: Pre-check JSON files
      id: file_check
      run: |
        # 快速检测是否有需要移动的JSON文件
        count=$(find . -maxdepth 1 -name '*.json' | grep -c .)
        echo "需要移动的文件数: $count"
        echo "has_files=$([ $count -gt 0 ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

    - name: Migrate Files
      if: steps.file_check.outputs.has_files == 'true'
      run: |
        mkdir -p SY
        # 使用批量移动命令优化性能
        find . -maxdepth 1 -name '*.json' -exec mv -t SY/ {} + 2>/dev/null || true
        echo "移动完成，耗时: $SECONDS 秒"

    - name: Smart Commit
      if: steps.file_check.outputs.has_files == 'true'
      run: |
        git config --global user.name "GitHub Bot"
        git config --global user.email "bot@noreply.github.com"
        git add -u  # 仅跟踪已修改文件
        # 使用轻量级提交检测
        if ! git diff-index --quiet HEAD --; then
          git commit -m "⚡ Auto-sync JSON files [skip ci]" --no-verify
          git push
          echo "变更已提交"
        fi
