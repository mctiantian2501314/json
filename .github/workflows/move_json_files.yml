name: Secure JSON Migration

on:
  push:
    paths:
      - '*.json'
    branches: [ main ]

jobs:
  sync-json:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    permissions:
      contents: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Migrate Files
      id: migration
      run: |
        mkdir -p SY
        # 记录原始文件列表
        find . -maxdepth 1 -name '*.json' | sed 's#./##' > original_files.txt
        # 执行带冲突处理的迁移
        find . -maxdepth 1 -type f -name '*.json' -exec sh -c '
          for file do
            dest="SY/$(basename "$file")"
            if [ -e "$dest" ]; then
              echo "::warning file=$file::同名文件已存在，执行覆盖"
            fi
            mv -f "$file" "$dest"
          done
        ' sh {} +

    - name: Verify Migration
      run: |
        # 生成迁移后文件列表
        find SY -name '*.json' | sed 's#SY/##' > migrated_files.txt
        
        # 使用排序比较差异
        diff_result=$(comm -23 <(sort original_files.txt) <(sort migrated_files.txt))
        
        if [ -n "$diff_result" ]; then
          echo "::error ::以下文件未成功迁移："
          echo "$diff_result"
          exit 1
        fi
        echo "校验通过 ✅ 所有文件已迁移"

    - name: Commit Changes
      run: |
        git config --global user.name "File Sync Bot"
        git config --global user.email "bot@noreply.github.com"
        git add .
        if ! git diff-index --quiet HEAD --; then
          git commit -m "♻️ 完成JSON文件安全迁移 [skip ci]"
          git push
        fi
