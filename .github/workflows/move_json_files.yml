name: Exact Filename Migration

on:
  push:
    paths:
      - '*.json'
    branches: [ main ]

jobs:
  sync-json:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    permissions:
      contents: write

    steps:
    - name: Checkout (Atomic)
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Atomic Migration
      run: |
        # 创建目标目录（如果不存在）
        mkdir -p SY
        
        # 安全迁移文件（处理所有极端情况）
        find . -maxdepth 1 -type f -name '*.json' -exec sh -c '
          for file do
            filename=$(basename "$file")
            dest="SY/$filename"
            
            # 检测文件是否已存在
            if [ -e "$dest" ]; then
              echo "检测到同名文件: $filename"
              echo "::warning ::文件 $filename 已存在，跳过迁移"
              continue
            fi
            
            # 原子操作迁移文件
            mv --no-clobber -v "$file" "$dest"
          done
        ' sh {} +

    - name: Verify Integrity
      run: |
        # 校验文件名一致性
        echo "校验迁移结果："
        find . -maxdepth 1 -name '*.json' && { echo "错误：仍有未迁移文件"; exit 1; }
        find SY -name '*.json' | sed 's#SY/##' | diff <(find . -maxdepth 1 -name '*.json' | sed 's#./##') - || { echo "文件名不一致"; exit 1; }

    - name: Commit Changes
      run: |
        git config --global user.name "File Keeper"
        git config --global user.email "keeper@noreply.github.com"
        git add -A
        if ! git diff-index --quiet HEAD --; then
          git commit -m "迁移JSON文件 [hash:$(git rev-parse --short HEAD)]"
          git push
        fi
