name: Safe JSON Migration

on:
  push:
    paths:
      - '*.json'
    branches: [ main ]

jobs:
  sync-json:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    permissions:
      contents: write

    steps:
    - name: Checkout (Shallow)
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Validate Files
      id: validation
      run: |
        # 使用带引号处理的查找命令
        file_count=$(find . -maxdepth 1 -name '*.json' -print | grep -c .)
        echo "检测到 $file_count 个待处理文件"
        echo "has_files=$([ $file_count -gt 0 ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

    - name: Safe Migration
      if: steps.validation.outputs.has_files == 'true'
      run: |
        mkdir -p SY
        # 使用带引号的安全处理方式
        find . -maxdepth 1 -name '*.json' -print0 | xargs -0 -I {} mv -v "{}" "SY/"
        echo "文件迁移完成，保留原始文件名"

    - name: Conflict Check
      if: steps.validation.outputs.has_files == 'true'
      run: |
        # 检测文件名冲突
        conflict_files=$(git diff --name-only --diff-filter=U)
        if [ -n "$conflict_files" ]; then
          echo "发现冲突文件: $conflict_files"
          exit 1
        fi

    - name: Commit Changes
      if: steps.validation.outputs.has_files == 'true'
      run: |
        git config --global user.name "File Sync Bot"
        git config --global user.email "bot@noreply.github.com"
        git add .
        if ! git diff-index --quiet HEAD --; then
          git commit -m "♻️ 安全迁移JSON文件 [skip ci]" 
          git push
        fi
